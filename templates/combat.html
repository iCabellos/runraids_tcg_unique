{% extends "layout.html" %}

{% block title %}Raid PvE - Combate{% endblock %}

{% block content %}
<style>
    .combat-wrapper {
        background: linear-gradient(to bottom, #121212, #1f1f1f);
        border-radius: 15px;
        padding: 20px;
        color: white;
        box-shadow: 0 0 10px #0ff3, 0 0 20px #0ff2;
    }

    .character-img,
    .enemy-img {
        width: 110px;
        height: 110px;
        border-radius: 12px;
        transition: transform 0.3s ease;
    }

    .float {
        animation: float 2s infinite ease-in-out;
    }

    .shake {
        animation: shake 1.5s infinite alternate;
    }

    @keyframes float {
        0% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
        100% { transform: translateY(0); }
    }

    @keyframes shake {
        0% { transform: rotate(1deg); }
        50% { transform: rotate(-1deg); }
        100% { transform: rotate(1deg); }
    }

    .impact-effect {
        animation: impactFlash 0.4s ease-in-out;
    }

    @keyframes impactFlash {
        0% { box-shadow: 0 0 0px red; transform: scale(1); }
        50% { box-shadow: 0 0 15px red; transform: scale(1.08); }
        100% { box-shadow: 0 0 0px red; transform: scale(1); }
    }

    .attack-animation {
        animation: attackMove 0.3s ease-in-out;
    }

    @keyframes attackMove {
        0% { transform: translateX(0); }
        50% { transform: translateX(10px); }
        100% { transform: translateX(0); }
    }

    .combat-log {
        background-color: #222;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border-radius: 8px;
    }

    .combat-log li {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .ability-button {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.1rem;
    }

    #formHidden {
        display: none;
    }
    .ability-btn {
        min-width: 45%;
        font-size: 1rem;
        font-weight: bold;
        padding: 14px 20px;
        border-radius: 10px;
        border: none;
        color: white;
        transition: transform 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .ability-btn:hover {
        transform: scale(1.05);
    }

    /* Colores por tipo */
    .btn-damage {
        background-color: #ff4d4d; /* rojo intenso */
    }

    .btn-heal {
        background-color: #4dff88; /* verde brillante */
        color: black;
    }

    .btn-buff {
        background-color: #4da6ff; /* azul el√©ctrico */
    }

    .btn-debuff {
        background-color: #a04dff; /* p√∫rpura fuerte */
    }

    /* Responsive */
    @media (max-width: 576px) {
        .ability-btn {
            min-width: 100%;
            font-size: 1.1rem;
        }
    }

</style>

<section class="py-4">
    <div class="container combat-wrapper text-center">

        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <h3 class="mb-4">‚öîÔ∏è {{ hero.hero.name }} (Nv. {{ hero.get_level }}) vs {{ enemy.name }}</h3>

        <div class="d-flex justify-content-around align-items-center mb-4">
            <div>
                <img src="{{ hero.hero.image.url }}" alt="Hero Image" class="character-img float" id="hero-img">
                <div class="mt-2" id="hero-hp">‚ù§Ô∏è {{ hero_hp }} HP</div>
            </div>
            <div>
                <img src="{{ enemy.image.url }}" alt="Enemy Image" class="enemy-img shake" id="enemy-img">
                <div class="mt-2" id="enemy-hp">üíÄ {{ enemy_hp }} HP</div>
            </div>
        </div>

        <div class="combat-log mb-3 text-start">
            <h5 class="mb-2">Registro del combate</h5>
            <ul class="list-unstyled mb-0" id="combat-log">
                {% for line in log %}
                <li>üìù {{ line }}</li>
                {% empty %}
                <li>‚è≥ El combate est√° a punto de comenzar...</li>
                {% endfor %}
            </ul>
        </div>

        {% if not winner %}
        <form method="post" class="mt-3" id="formHidden">
            {% csrf_token %}
            <div class="mb-3 text-start">
                <label class="form-label"><strong>Elige tu habilidad:</strong></label>
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for ability in hero.hero.abilities.all %}
                    <button
                            type="submit"
                            name="ability_id"
                            value="{{ ability.id }}"
                            class="btn ability-btn btn-{{ ability.type }}"
                    >
                        {{ ability.name }}, {{ ability.id }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </form>

        {% else %}
        <div class="alert alert-info mt-4">
            <strong>üèÅ Combate finalizado:</strong> {{ winner }}<br>
            <a href="{% url 'combat' %}" class="btn btn-warning mt-3">üîÅ Reintentar combate</a>
        </div>
        {% endif %}

        <a href="{% url 'userprofile' %}" class="btn btn-secondary mt-3">üè† Volver al Dashboard</a>
    </div>
</section>

<script>
    window.onload = function () {
        const heroImg = document.getElementById("hero-img");
        const enemyImg = document.getElementById("enemy-img");
        const logItems = document.querySelectorAll('#combat-log li');
        const lastLine = logItems[logItems.length - 1]?.textContent || "";

        const form = document.getElementById("formHidden");

        let delay = 0;

        if (lastLine.includes("hace")) {
            if (lastLine.includes("{{ hero.hero.name }}")) {
                // El enemigo atac√≥ al h√©roe
                setTimeout(() => {
                    enemyImg.classList.add("attack-animation");
                    setTimeout(() => {
                        heroImg.classList.add("impact-effect");
                        setTimeout(() => {
                            enemyImg.classList.remove("attack-animation");
                            heroImg.classList.remove("impact-effect");
                            form.style.display = "block";
                        }, 400);
                    }, 200);
                }, 300);
                delay = 1000;
            } else if (lastLine.includes("{{ enemy.name }}")) {
                // El h√©roe atac√≥ al enemigo
                setTimeout(() => {
                    heroImg.classList.add("attack-animation");
                    setTimeout(() => {
                        enemyImg.classList.add("impact-effect");
                        setTimeout(() => {
                            heroImg.classList.remove("attack-animation");
                            enemyImg.classList.remove("impact-effect");
                            form.style.display = "block";
                        }, 400);
                    }, 200);
                }, 300);
                delay = 1000;
            }
        } else {
            form.style.display = "block"; // Mostrar si no hubo acci√≥n
        }
    };

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("formHidden");
        const heroImg = document.getElementById("hero-img");
        const enemyImg = document.getElementById("enemy-img");

        if (!form) return;

        form.querySelectorAll("button[type='submit']").forEach((button) => {
            button.addEventListener("click", function (e) {
                e.preventDefault();

                // Desactivar botones
                form.querySelectorAll("button").forEach(btn => btn.disabled = true);

                const selectedAbilityId = this.value; // este bot√≥n espec√≠fico

                // Animaciones
                heroImg.classList.add("attack-animation");
                setTimeout(() => {
                    enemyImg.classList.add("impact-effect");
                }, 200);

                // Despu√©s de animaci√≥n, enviar formulario
                setTimeout(() => {
                    heroImg.classList.remove("attack-animation");
                    enemyImg.classList.remove("impact-effect");

                    // Crear formulario oculto con SOLO el ability_id correcto
                    const hiddenForm = document.createElement("form");
                    hiddenForm.method = "post";
                    hiddenForm.style.display = "none";

                    // A√±adir CSRF token desde el formulario original
                    const csrfInput = form.querySelector("input[name='csrfmiddlewaretoken']");
                    if (csrfInput) {
                        const token = document.createElement("input");
                        token.type = "hidden";
                        token.name = "csrfmiddlewaretoken";
                        token.value = csrfInput.value;
                        hiddenForm.appendChild(token);
                    }

                    // A√±adir habilidad seleccionada
                    const abilityInput = document.createElement("input");
                    abilityInput.type = "hidden";
                    abilityInput.name = "ability_id";
                    abilityInput.value = selectedAbilityId;
                    hiddenForm.appendChild(abilityInput);

                    document.body.appendChild(hiddenForm);
                    hiddenForm.submit();
                }, 700);
            });
        });
    });
</script>
{% endblock content %}
