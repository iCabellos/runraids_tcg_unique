{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tu Campamento</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      background: url('{% static "img/background_camp.png" %}') no-repeat center center fixed;
      background-size: cover;
    }

    .city-wrapper { position: relative; width: 100%; height: 100%; }

    .building {
      position: absolute;
      text-align: center;
      cursor: pointer;
      transition: transform .3s ease, filter .3s ease;
      transform-origin: 50% 100%;
    }

    .building img { width: 100%; height: auto; display:block; }

    .level-label {
      position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.7); padding: 4px 8px; border-radius: 6px;
      font-size: 14px; color: #00ffcc; box-shadow: 0 0 5px #00ffcc;
    }

    /* Modal */
    .modal {
      display: none; position: fixed; z-index: 999; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }

    .modal-content {
      background-color: #222;
      margin: 10% auto;
      padding: 20px;
      border: 2px solid #00ffcc;
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
      color: white;
    }

    .modal h2 {
      margin-top: 0;
      color: #00ffcc;
    }

    .modal ul {
      list-style: none;
      padding: 0;
    }

    .modal ul li {
      margin-bottom: 6px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #fff;
    }

    /* Responsive buildings */
    @media (max-width: 480px)  { .building { width: 220px; } }
    @media (min-width: 481px) and (max-width: 1100px) { .building { width: 400px; } }
    @media (min-width: 1101px) { .building { width: 200px; } }

    @media (max-width: 480px)  { .building { top: var(--top-mobile); left: var(--left-mobile); } }
    @media (min-width: 481px) and (max-width: 1100px) { .building { top: var(--top-ipad); left: var(--left-ipad); } }
    @media (min-width: 1101px) { .building { top: var(--top-pc); left: var(--left-pc); } }
  </style>
</head>
<body>
  <div class="city-wrapper">
    {% for building in buildings %}

      {% cycle '35' '20' '55' '15' '55' '0' '0' '0' as pc_top silent %}
      {% cycle '35'  '60' '35' '15' '70' '0' '0' '0' as pc_left silent %}
      {% cycle '35' '20' '55' '15' '55' '0' '0' '0' as ipad_top silent %}
      {% cycle '35'  '60' '35' '15' '70' '0' '0' '0' as ipad_left silent %}
      {% cycle '8' '65' '22' '30' '70' '0' '0' '0' as mob_top silent %}
      {% cycle '37'  '30' '3' '45' '70' '0' '0' '0' as mob_left silent %}

      <div
        class="building b-{{ building.type }}"
        data-building-id="{{ building.id }}"
        data-building-name="{{ building.name }}"
        style="
          --top-pc: {% firstof building.pos_pc_top pc_top %}%;
          --left-pc: {% firstof building.pos_pc_left pc_left %}%;
          --top-ipad: {% firstof building.pos_ipad_top ipad_top %}%;
          --left-ipad: {% firstof building.pos_ipad_left ipad_left %}%;
          --top-mobile: {% firstof building.pos_mobile_top mob_top %}%;
          --left-mobile: {% firstof building.pos_mobile_left mob_left %}%;
          z-index: {{ building.z_index|default:1 }};
        "
        onclick="openModal({{ building.id }})"
      >
        <div class="level-label">
          Lv. {{ building.level }}
          {% if building.can_upgrade %}
            <span style="color: lime; font-size: 16px;">⬆</span>
          {% endif %}
        </div>
        <img src="{{ building.image }}" alt="{{ building.name }}">
      </div>

      <!-- Modal por edificio -->
      <div id="modal-{{ building.id }}" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal({{ building.id }})">&times;</span>
          <h2>{{ building.name }} - Nivel {{ building.level }}</h2>

          {% if building.is_max_level %}
            <p style="color: gold;">Nivel máximo alcanzado</p>
          {% else %}
            <p>Costes para subir al nivel {{ building.level|add:1 }}:</p>
            <ul>
              {% for cost in building.upgrade_costs %}
                <li>{{ cost.resource_type.name }}: {{ cost.amount }}</li>
              {% endfor %}
            </ul>
            {% if building.can_upgrade %}
              <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="building_id" value="{{ building.id }}">
                <button type="submit" style="padding: 6px 12px; background: lime; color: black; border: none; border-radius: 5px; font-weight: bold;">
                  Mejorar
                </button>
              </form>
            {% else %}
              <p style="color: red;">No tienes suficientes recursos.</p>
            {% endif %}
          {% endif %}
        </div>
      </div>

    {% endfor %}
  </div>

  <script>
    function openModal(id) {
      document.getElementById(`modal-${id}`).style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(`modal-${id}`).style.display = "none";
    }

    // Cerrar al hacer clic fuera del modal
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) modal.style.display = "none";
      });
    };
  </script>
</body>
</html>
