{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sala de Matchmaking - RunRaids TCG</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap');

    html, body {
      margin: 0; padding: 0; width: 100%; min-height: 100vh;
      font-family: 'Orbitron', sans-serif;
      background: url('{% static "img/background_camp.png" %}') no-repeat center center fixed;
      background-size: cover; color: white; overflow-x: hidden;
    }

    .container {
      position: relative; width: 100%; min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px; box-sizing: border-box;
      background: rgba(0,0,0,0.7);
    }

    .header {
      text-align: center; margin-bottom: 30px;
    }

    .title {
      font-size: 32px; font-weight: 700; color: #00ffcc;
      text-shadow: 0 0 20px #00ffcc; margin: 0 0 10px 0;
    }

    .raid-info {
      font-size: 16px; color: rgba(255,255,255,0.8);
      margin-bottom: 20px;
    }

    .timer {
      font-size: 18px; color: #ffaa00; font-weight: 600;
      background: rgba(255,170,0,0.1); padding: 8px 16px;
      border-radius: 20px; border: 2px solid #ffaa00;
    }

    .players-section {
      width: 100%; max-width: 800px; margin-bottom: 30px;
    }

    .players-grid {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 20px; margin-bottom: 20px;
    }

    .player-slot {
      background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
      border-radius: 15px; padding: 20px; text-align: center;
      min-height: 120px; display: flex; flex-direction: column;
      justify-content: center; align-items: center; position: relative;
      transition: all 0.3s ease;
    }

    .player-slot.occupied {
      border-color: var(--player-color, #00ffcc);
      background: rgba(var(--player-color-rgb, 0,255,204), 0.1);
    }

    .player-slot.waiting {
      border-style: dashed; animation: pulse-waiting 2s infinite;
    }

    @keyframes pulse-waiting {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    .player-crown {
      position: absolute; top: -10px; right: -10px;
      background: #ffd700; color: #000; border-radius: 50%;
      width: 30px; height: 30px; display: flex; align-items: center;
      justify-content: center; font-size: 16px; font-weight: bold;
      box-shadow: 0 0 10px rgba(255,215,0,0.5);
    }

    .player-avatar {
      width: 60px; height: 60px; border-radius: 50%;
      background: var(--player-color, #666); margin-bottom: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: white; font-weight: bold;
    }

    .player-name {
      font-weight: 600; margin-bottom: 5px;
      color: var(--player-color, white);
    }

    .player-status {
      font-size: 12px; color: rgba(255,255,255,0.7);
    }

    .waiting-text {
      color: rgba(255,255,255,0.5); font-style: italic;
    }

    .controls {
      display: flex; gap: 20px; justify-content: center;
      flex-wrap: wrap; margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px; border: none; border-radius: 8px;
      font-family: 'Orbitron', sans-serif; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease;
      text-decoration: none; display: inline-block;
      position: relative; overflow: hidden;
    }

    .btn::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: #00ffcc; color: #000;
    }

    .btn-primary:hover {
      background: #00e6b8; transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0,255,204,0.5);
    }

    .btn-secondary {
      background: #666; color: white;
    }

    .btn-secondary:hover {
      background: #777; transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(119,119,119,0.5);
    }

    .btn-danger {
      background: #ff4444; color: white;
    }

    .btn-danger:hover {
      background: #ff6666; transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(255,68,68,0.5);
    }

    .btn:disabled {
      background: #333; color: #666; cursor: not-allowed;
      transform: none; box-shadow: none;
    }

    .btn:disabled::before {
      display: none;
    }

    .status-message {
      text-align: center; font-size: 16px; margin-bottom: 20px;
      padding: 10px 20px; border-radius: 10px;
      background: rgba(0,255,204,0.1); border: 1px solid #00ffcc;
    }

    /* Colores de jugadores */
    .player-color-1 { --player-color: #00ffcc; --player-color-rgb: 0,255,204; }
    .player-color-2 { --player-color: #ff6b6b; --player-color-rgb: 255,107,107; }
    .player-color-3 { --player-color: #4ecdc4; --player-color-rgb: 78,205,196; }
    .player-color-4 { --player-color: #ffe66d; --player-color-rgb: 255,230,109; }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .title { font-size: 24px; }
      .players-grid { grid-template-columns: 1fr; gap: 15px; }
      .controls { gap: 10px; }
      .btn { padding: 10px 20px; font-size: 14px; }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      /* iPad styles */
      .player-avatar { width: 80px; height: 80px; font-size: 32px; }
      .player-slot { min-height: 150px; padding: 25px; }
      .btn { padding: 15px 30px; font-size: 16px; }
    }
  </style>
</head>
<body>
  {% if error %}
    <div class="container">
      <div style="text-align: center;">
        <h2 style="color: #ff4444;">{{ error }}</h2>
        <a href="{% url 'matchmaking' %}" class="btn btn-primary">Volver al Matchmaking</a>
      </div>
    </div>
  {% else %}
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1 class="title">Sala de Matchmaking</h1>
        <div class="raid-info" id="raid-info">
          {% if room.raid %}{{ room.raid.name }} - {{ room.raid.difficulty|title }}{% else %}Raid Personalizada{% endif %}
        </div>
        <div class="timer" id="timer">Esperando...</div>
      </div>

      <!-- Status Message -->
      <div class="status-message" id="status-message">
        Esperando jugadores...
      </div>

      <!-- Players Grid -->
      <div class="players-section">
        <div class="players-grid" id="players-grid">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="btn btn-primary" id="start-btn" onclick="startRaid()" style="display:none;">
          ‚öîÔ∏è Iniciar Raid
        </button>
        <button class="btn btn-secondary" onclick="leaveRoom()">
          üö™ Salir de la Sala
        </button>
      </div>
    </div>
  {% endif %}

  <script>
    const ROOM_ID = {{ room.id|default:'null' }};
    const MEMBER_ID = {{ request.session.member_id|default:'null' }};
    const IS_OWNER = {{ is_owner|yesno:"true,false" }};
    
    let pollInterval = null;
    let roomStartTime = null;
    let timerInterval = null;
    
    const PLAYER_COLORS = ['player-color-1', 'player-color-2', 'player-color-3', 'player-color-4'];
    const MAX_WAIT_TIME = 4 * 60; // 4 minutos en segundos
    const AUTO_READY_TIME = 5; // 5 segundos para auto-ready

    async function pollRoomState() {
      if (!ROOM_ID) return;
      
      try {
        const response = await fetch(`/api/raid/state/${ROOM_ID}/`);
        const data = await response.json();
        
        if (data.ok) {
          updateRoomUI(data.state);
          
          // Si la raid ha comenzado, redirigir
          if (data.state.state === 'in_progress') {
            window.location.href = `/raid/room/${ROOM_ID}/`;
          }
        }
      } catch (error) {
        console.error('Error polling room state:', error);
      }
    }

    function updateRoomUI(state) {
      updatePlayersGrid(state);
      updateControls(state);
      updateStatusMessage(state);
    }

    function updatePlayersGrid(state) {
      const playersGrid = document.getElementById('players-grid');
      playersGrid.innerHTML = '';
      
      // Crear 4 slots siempre
      for (let i = 0; i < 4; i++) {
        const slot = document.createElement('div');
        slot.className = `player-slot ${PLAYER_COLORS[i]}`;
        
        const participant = state.participants[i];
        if (participant) {
          slot.classList.add('occupied');
          
          const isOwner = state.room_id && participant.member_id === {{ room.owner.id|default:'null' }};
          
          slot.innerHTML = `
            ${isOwner ? '<div class="player-crown">üëë</div>' : ''}
            <div class="player-avatar">${participant.member_name.charAt(0).toUpperCase()}</div>
            <div class="player-name">${participant.member_name}</div>
            <div class="player-status">${participant.is_ready ? 'Listo' : 'Prepar√°ndose...'}</div>
          `;
        } else {
          slot.classList.add('waiting');
          slot.innerHTML = `
            <div class="player-avatar">?</div>
            <div class="waiting-text">Esperando jugador...</div>
          `;
        }
        
        playersGrid.appendChild(slot);
      }
    }

    function updateControls(state) {
      const startBtn = document.getElementById('start-btn');
      
      if (IS_OWNER && state.state === 'ready') {
        startBtn.style.display = 'inline-block';
      } else {
        startBtn.style.display = 'none';
      }
    }

    function updateStatusMessage(state) {
      const statusMessage = document.getElementById('status-message');
      const playerCount = state.participants.length;
      
      if (state.state === 'waiting') {
        statusMessage.textContent = `Esperando jugadores... (${playerCount}/4)`;
      } else if (state.state === 'ready') {
        statusMessage.textContent = `¬°Listo para comenzar! (${playerCount} jugador${playerCount !== 1 ? 'es' : ''})`;
      }
    }

    function updateTimer() {
      if (!roomStartTime) return;
      
      const elapsed = Math.floor((Date.now() - roomStartTime) / 1000);
      const remaining = Math.max(0, MAX_WAIT_TIME - elapsed);
      
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      
      const timerEl = document.getElementById('timer');
      
      if (elapsed < AUTO_READY_TIME) {
        timerEl.textContent = `Esperando... ${AUTO_READY_TIME - elapsed}s`;
      } else if (remaining > 0) {
        timerEl.textContent = `Auto-inicio en: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else {
        timerEl.textContent = 'Iniciando...';
      }
    }

    async function startRaid() {
      try {
        const response = await fetch(`/api/raid/start/${ROOM_ID}/`, {
          method: 'POST'
        });
        
        const data = await response.json();
        if (data.ok) {
          window.location.href = `/raid/room/${ROOM_ID}/`;
        } else {
          alert('Error iniciando raid: ' + (data.error || 'Error desconocido'));
        }
      } catch (error) {
        alert('Error de conexi√≥n: ' + error.message);
      }
    }

    function leaveRoom() {
      if (confirm('¬øSeguro que quieres salir de la sala?')) {
        window.location.href = '{% url "matchmaking" %}';
      }
    }

    // Inicializar
    if (ROOM_ID) {
      roomStartTime = Date.now();
      pollRoomState();
      pollInterval = setInterval(pollRoomState, 1000);
      timerInterval = setInterval(updateTimer, 1000);
    }

    // Limpiar al salir
    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
      if (timerInterval) clearInterval(timerInterval);
    });
  </script>
</body>
</html>
