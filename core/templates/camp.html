{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tu Campamento</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      background: url('{% static "img/background_camp.png" %}') no-repeat center center fixed;
      background-size: cover;
    }

    .city-wrapper { position: relative; width: 100%; height: 100%; }

    .building {
      position: absolute;
      text-align: center;
      cursor: pointer;
      transition: transform .3s ease, filter .3s ease;
      transform-origin: 50% 100%;
    }

    .building img { width: 100%; height: auto; display:block; }

    .level-label {
      position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.7); padding: 4px 8px; border-radius: 6px;
      font-size: 14px; color: #00ffcc; box-shadow: 0 0 5px #00ffcc;
    }

    /* Modal */
    .modal {
      display: none; position: fixed; z-index: 999; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }

    .modal-content {
      background-color: #222;
      margin: 10% auto;
      margin-top: 30%;
      padding: 20px;
      border: 2px solid #00ffcc;
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
      color: white;
    }

    .modal h2 {
      margin-top: 0;
      color: #00ffcc;
    }

    .modal ul {
      list-style: none;
      padding: 0;
    }

    .modal ul li {
      margin-bottom: 6px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #fff;
    }

    /* üîπ UID discreto arriba */
  .top-uid {
    position: fixed;
    top: 6px;
    right: 10px;
    font-size: 11px;
    letter-spacing: .5px;
    color: rgba(255,255,255,.7);
    background: rgba(0,0,0,.35);
    padding: 3px 6px;
    border-radius: 6px;
    z-index: 1000;
    user-select: text;
  }

  /* üîπ Barra de recursos a la izquierda en horizontal */
  .resource-bar {
    position: fixed;
    top: 12px;
    left: 12px;
    display: flex;
    gap: 12px;
    align-items: center;
    z-index: 1000;
    padding: 8px 10px;
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.15);
    border-radius: 10px;
    backdrop-filter: blur(2px);
  }

  .resource-item {
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 90px;
  }

  .resource-item img {
    width: 28px; height: 28px; object-fit: contain; display: block;
    filter: drop-shadow(0 1px 1px rgba(0,0,0,.5));
  }

  .resource-amount {
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    text-shadow: 0 2px 3px rgba(0,0,0,.8), 0 0 3px rgba(0,0,0,.8);
  }

  .resource-name {
    color: rgba(255,255,255,.8);
    font-size: 12px;
  }

  @media (max-width: 520px) {
    .resource-bar { gap: 8px; padding: 6px 8px; }
    .resource-item { min-width: 70px; }
    .resource-item img { width: 24px; height: 24px; }
    .resource-amount { font-size: 14px; }
    .resource-name { display:none; } /* ahorrar espacio en m√≥vil */
  }

  /* Bot√≥n flotante de matchmaking */
  .matchmaking-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 70px;
    height: 70px;
    background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    border: 3px solid #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    transition: all 0.3s ease;
    z-index: 1000;
    animation: pulse 2s infinite;
  }

  .matchmaking-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
  }

  @keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); }
    50% { box-shadow: 0 4px 25px rgba(255, 107, 107, 0.8); }
    100% { box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); }
  }

    /* Responsive buildings */
    @media (max-width: 480px)  { .building { width: 220px; } }
    @media (min-width: 481px) and (max-width: 1100px) { .building { width: 400px; } }
    @media (min-width: 1101px) { .building { width: 200px; } }

    @media (max-width: 480px)  { .building { top: var(--top-mobile); left: var(--left-mobile); } }
    @media (min-width: 481px) and (max-width: 1100px) { .building { top: var(--top-ipad); left: var(--left-ipad); } }
    @media (min-width: 1101px) { .building { top: var(--top-pc); left: var(--left-pc); } }
  </style>
</head>
<body>
<div class="top-uid">UID: {{ member.id }}</div>

  <!-- üîπ Barra de recursos del jugador -->
    <div class="resource-bar">
        {% for res in resources %}
        <div class="resource-item">
          {% if res.image %}
            <img src="{{ res.image }}" alt="{{ res.name }}">
          {% else %}
            <img src="{% static 'img/resource_placeholder.png' %}" alt="{{ res.name }}">
          {% endif %}
          <div>
            <div class="resource-amount">{{ res.amount }}</div>
            <div class="resource-name">{{ res.name }}</div>
          </div>
        </div>
        {% endfor %}
    </div>
  <div class="city-wrapper">
    {% for building in buildings %}

      {% cycle '35' '20' '55' '15' '55' '0' '0' '0' as pc_top silent %}
      {% cycle '35'  '60' '35' '15' '70' '0' '0' '0' as pc_left silent %}
      {% cycle '35' '20' '55' '15' '55' '0' '0' '0' as ipad_top silent %}
      {% cycle '35'  '60' '35' '15' '70' '0' '0' '0' as ipad_left silent %}
      {% cycle '8' '65' '22' '30' '70' '0' '0' '0' as mob_top silent %}
      {% cycle '37'  '30' '3' '45' '70' '0' '0' '0' as mob_left silent %}

      <div
        class="building b-{{ building.type }}"
        data-building-id="{{ building.id }}"
        data-building-name="{{ building.name }}"
        style="
          --top-pc: {% firstof building.pos_pc_top pc_top %}%;
          --left-pc: {% firstof building.pos_pc_left pc_left %}%;
          --top-ipad: {% firstof building.pos_ipad_top ipad_top %}%;
          --left-ipad: {% firstof building.pos_ipad_left ipad_left %}%;
          --top-mobile: {% firstof building.pos_mobile_top mob_top %}%;
          --left-mobile: {% firstof building.pos_mobile_left mob_left %}%;
          z-index: {{ building.z_index|default:1 }};
        "
        onclick="openModal({{ building.id }})"
      >
        <div class="level-label">
          Lv. {{ building.level }}
          {% if building.can_upgrade %}
            <span style="color: lime; font-size: 16px;">‚¨Ü</span>
          {% endif %}
        </div>
        <img src="{{ building.image }}" alt="{{ building.name }}">
      </div>

      <!-- Modal por edificio -->
      <div id="modal-{{ building.id }}" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal({{ building.id }})">&times;</span>
          <h2>{{ building.name }} - Nivel {{ building.level }}</h2>

          {% if building.is_max_level %}
            <p style="color: gold;">Nivel m√°ximo alcanzado</p>
          {% else %}
            <p>Costes para subir al nivel {{ building.level|add:1 }}:</p>
            <ul>
              {% for cost in building.upgrade_costs %}
                <li>
                  {% if cost.resource_type.image_url %}
                    <img src="{{ cost.resource_type.image_url }}" alt="{{ cost.resource_type.name }}"
                         style="width:40px;height:40px;object-fit:contain;"/>
                  {% endif %}
                  {{ cost.amount }}
                </li>
              {% endfor %}
            </ul>
            {% if building.can_upgrade %}
              <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="building_id" value="{{ building.id }}">
                <button type="submit" style="padding: 6px 12px; background: lime; color: black; border: none; border-radius: 5px; font-weight: bold;">
                  Mejorar
                </button>
              </form>
            {% else %}
              <p style="color: red;">No tienes suficientes recursos.</p>
            {% endif %}
          {% endif %}
        </div>
      </div>

    {% endfor %}
  </div>

  <!-- Bot√≥n flotante para matchmaking -->
  <a href="{% url 'matchmaking' %}" class="matchmaking-btn" title="Matchmaking">
    ‚öîÔ∏è
  </a>

  <script>
    function openModal(id) {
      document.getElementById(`modal-${id}`).style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(`modal-${id}`).style.display = "none";
    }

    // Cerrar al hacer clic fuera del modal
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) modal.style.display = "none";
      });
    };
  </script>
</body>
</html>
